"use strict";var lineMargin={top:60,right:40,bottom:70,left:80},lineW=parseInt(d3.select("#line-div").style("width"),10),lineW=lineW-lineMargin.left-lineMargin.right,lineH=parseInt(d3.select("#line-div").style("height"),10),lineH=lineH-lineMargin.top-lineMargin.bottom,lineDuration=600,tipDuration=200,parseDate=d3.timeParse("%d-%b-%y"),formatTimeWeek=d3.timeFormat("%d-%b-%y"),formatTimeMonth=d3.timeFormat("%b"),formatTimeYear=d3.timeFormat("%Y"),xScale=d3.scaleTime().range([0,lineW]),yScale=d3.scaleLinear().range([lineH,0]),dotRadius="0.25em",dataTitle="Total Revenue ($US)";d3.csv("/8step.io/production_data/ctc_data/ctc_lines.csv",function(t){return t.date=parseDate(t.date),t.division_clean=t.division_clean,t.avg_revenue=+t.avg_revenue,t.projects_share=+t.projects_share,t.projects_total=+t.projects_total,t.revenue_share=+t.revenue_share,t.revenue_total=+t.revenue_total,t},function(error,data){error?console.log(error):console.log(data);var timeData=data,ushData=data.filter(function(t){return"USH"==t.division_clean}),sepData=data.filter(function(t){return"SEP"==t.division_clean}),ihdData=data.filter(function(t){return"IHD"==t.division_clean}),iegData=data.filter(function(t){return"IEG"==t.division_clean}),enrData=data.filter(function(t){return"ENR"==t.division_clean}),lineData=function(t){return t.revenue_total};xScale.domain(d3.extent(timeData,function(t){return t.date})),yScale.domain(d3.extent(timeData,function(t){return lineData(t)})).nice();var xAxis=d3.axisBottom().scale(xScale).tickFormat(formatTimeMonth),yAxis=d3.axisLeft().scale(yScale),line=d3.line().curve(d3.curveLinear).x(function(t){return xScale(t.date)}).y(function(t){return yScale(lineData(t))}),titleText=d3.select("#chart-title").append("text").attr("class","title-text").text(dataTitle+" by Division, CTC, FY17"),svg=d3.select("#line-div").append("svg").attr("width",lineW+lineMargin.left+lineMargin.right).attr("height",lineH+lineMargin.top+lineMargin.bottom).attr("id","line-canvas").append("g").attr("transform","translate("+lineMargin.left+","+lineMargin.top+")"),pathUSH=svg.append("path").datum(ushData).attr("d",line).attr("class","path").attr("id","ush-path"),nodesUSH=svg.selectAll("circle.ush-nodes").data(ushData).enter().append("circle").attr("class","nodes ush-nodes").attr("r",dotRadius).attr("cx",function(t){return xScale(t.date)}).attr("cy",function(t){return yScale(lineData(t))}),pathSEP=svg.append("path").datum(sepData).attr("d",line).attr("class","path").attr("id","sep-path"),nodesSEP=svg.selectAll("circle.sep-nodes").data(sepData).enter().append("circle").attr("class","nodes sep-nodes").attr("r",dotRadius).attr("cx",function(t){return xScale(t.date)}).attr("cy",function(t){return yScale(lineData(t))}),pathIHD=svg.append("path").datum(ihdData).attr("d",line).attr("class","path").attr("id","ihd-path"),nodesIHD=svg.selectAll("circle.ihd-nodes").data(ihdData).enter().append("circle").attr("class","nodes ihd-nodes").attr("r",dotRadius).attr("cx",function(t){return xScale(t.date)}).attr("cy",function(t){return yScale(lineData(t))}),pathIEG=svg.append("path").datum(iegData).attr("d",line).attr("class","path").attr("id","ieg-path"),nodesIEG=svg.selectAll("circle.ieg-nodes").data(iegData).enter().append("circle").attr("class","nodes ieg-nodes").attr("r",dotRadius).attr("cx",function(t){return xScale(t.date)}).attr("cy",function(t){return yScale(lineData(t))}),pathENR=svg.append("path").datum(enrData).attr("d",line).attr("class","path").attr("id","enr-path"),nodesENR=svg.selectAll("circle.enr-nodes").data(enrData).enter().append("circle").attr("class","nodes enr-nodes").attr("r",dotRadius).attr("cx",function(t){return xScale(t.date)}).attr("cy",function(t){return yScale(lineData(t))}),lineTip=d3.select("#line-div").append("div").attr("id","line-tip").style("display","none");d3.selectAll(".nodes").on("mouseover",function(t){lineTip.transition().duration(tipDuration).style("display","inline-block"),lineTip.html("<p><span class='line-val-display'>"+d3.format(",.2f")(lineData(t))+"</span><br /><span class='time-display'>"+formatTimeMonth(t.date)+" "+formatTimeYear(t.date)+"</span></p>").style("left",d3.select(this).attr("cx")).style("top",d3.select(this).attr("cy"))}).on("mouseout",function(){lineTip.transition().duration(tipDuration).style("display","none")}),svg.append("g").attr("class","axis x-axis").attr("transform","translate(0,"+lineH+")").call(xAxis),d3.selectAll(".x-axis text").attr("transform","rotate(-90)").attr("text-anchor","end"),svg.append("g").attr("class","axis y-axis").call(yAxis);var yLabelBox=d3.select(".y-axis text").node().getBBox(),yLabelShift=yLabelBox.x-50,yLabel=svg.append("text").text(dataTitle).attr("fill","gray").attr("text-anchor","middle").attr("transform","translate("+yLabelShift+","+lineH/2+"), rotate(-90)"),donutMargin={top:0,right:30,bottom:0,left:30},w=parseInt(d3.select("#donut-div").style("width"),10),w=w-donutMargin.left-donutMargin.right,h=parseInt(d3.select("#donut-div").style("height"),10),h=h-donutMargin.top-donutMargin.bottom,outerRadius=w/2*.88,innerRadius=w/2*.64,labelRadius=w/2*.98,tipDuration=200,donutDuration=600;d3.csv("/8step.io/production_data/ctc_data/divisions.csv",function(error,data){function arcTween(t){var a=d3.interpolate(this._current,t);return this._current=a(0),function(t){return arcDef(a(t))}}error?console.log(error):console.log(data);var donutData=data,arcData=function(t){return+t.revenue_total},svg=d3.select("#donut-div").append("svg").attr("width",w+donutMargin.left+donutMargin.right).attr("height",h+donutMargin.top+donutMargin.bottom).attr("id","donut-canvas").append("g").attr("transform","translate("+(w/2+donutMargin.left)+","+(h/2+donutMargin.top)+")"),color=d3.scaleOrdinal().range(["#FBAF43","#198F90","#9E004D","#F1594E","#9BD19D"]),arcDef=d3.arc().outerRadius(outerRadius).innerRadius(innerRadius),arcDefLabel=d3.arc().outerRadius(labelRadius).innerRadius(outerRadius),pie=d3.pie().sort(null).value(function(t){return arcData(t)}),arc=svg.selectAll("g.arc").data(pie(donutData)).enter().append("g").attr("class","arc"),arcPath=arc.append("path").attr("d",arcDef).attr("class","arc-path").style("fill",function(t){return color(t.data.division_clean)}).each(function(t){this._current=t}),donutLabels=arc.append("text").attr("transform",function(t){return"translate("+arcDefLabel.centroid(t)+")"}).attr("fill","white").attr("class","arc-label").attr("text-anchor",function(t){return(t.endAngle+t.startAngle)/2>Math.PI?"end":"start"}).text(function(t){return t.data.division_clean}),donutTip=d3.select("#donut-div").append("div").attr("class","tooltip donut-tip").style("position","absolute").style("left",(w+donutMargin.left+donutMargin.right)/2).style("top",h/2+donutMargin.top).style("opacity",0);arcPath.on("mouseover",function(t){donutTip.transition().duration(tipDuration).style("opacity",1),donutTip.html("<div class='title-display'>"+t.data.division_display+", FY17</div><br /><div class = data-display>Total Projects:<strong> "+t.data.projects_total+"</strong><br />Total Revenue: <strong>$"+d3.format(",.2f")(t.data.revenue_total)+"</strong><br />Avg Revenue/Project:<strong> $"+d3.format(",.2f")(t.data.avg_revenue)+"</strong></div>")}).on("mouseout",function(t){donutTip.transition().duration(tipDuration).style("opacity",0)}),d3.selectAll(".m-choice").on("click",function(){var lineValue=d3.select(this).attr("value"),arcValue=lineValue,lineData=function(d){return eval(lineValue)};switch(lineValue){case"d.projects_total":dataTitle="Total Projects";break;case"d.revenue_total":dataTitle="Total Revenue ($US)";break;case"d.avg_revenue":dataTitle="Avg. Revenue / Project ($US)"}titleText.text(dataTitle+" by Division, CTC, FY17"),d3.csv("/8step.io/production_data/ctc_data/ctc_lines.csv",function(t){return t.date=parseDate(t.date),t.division_clean=t.division_clean,t.avg_revenue=+t.avg_revenue,t.projects_share=+t.projects_share,t.projects_total=+t.projects_total,t.revenue_share=+t.revenue_share,t.revenue_total=+t.revenue_total,t},function(t,a){t&&console.log(t);var e=d3.scaleLinear().range([lineH,0]);e.domain(d3.extent(timeData,function(t){return lineData(t)})).nice();var n=d3.line().x(function(t){return xScale(t.date)}).y(function(t){return e(lineData(t))});d3.selectAll(".nodes").on("mouseover",function(t){lineTip.transition().duration(tipDuration).style("display","inline-block"),lineTip.html("<p><span class='line-val-display'>"+d3.format(",.2f")(lineData(t))+"</span><br /><span class='time-display'>"+formatTimeMonth(t.date)+" "+formatTimeYear(t.date)+"</span></p>").style("left",d3.select(this).attr("cx")).style("top",d3.select(this).attr("cy"))}).on("mouseout",function(){lineTip.transition().duration(tipDuration).style("display","none")}),pathUSH.transition().duration(lineDuration).attr("d",n),nodesUSH.transition().duration(lineDuration).attr("cy",function(t){return e(lineData(t))}),pathSEP.transition().duration(lineDuration).attr("d",n),nodesSEP.transition().duration(lineDuration).attr("cy",function(t){return e(lineData(t))}),pathIHD.transition().duration(lineDuration).attr("d",n),nodesIHD.transition().duration(lineDuration).attr("cy",function(t){return e(lineData(t))}),pathIEG.transition().duration(lineDuration).attr("d",n),nodesIEG.transition().duration(lineDuration).attr("cy",function(t){return e(lineData(t))}),pathENR.transition().duration(lineDuration).attr("d",n),nodesENR.transition().duration(lineDuration).attr("cy",function(t){return e(lineData(t))});var i=d3.axisLeft().scale(e);d3.select(".y-axis").transition().duration(lineDuration).call(i);d3.select(".y-axis text").node().getBBox();yLabel.text(dataTitle).transition().duration(lineDuration).attr("transform","translate("+yLabelShift+","+lineH/2+"), rotate(-90)")});var arcData=function(d){return eval(arcValue)};pie.value(function(t){return arcData(t)}),arcPath.data(pie(donutData)),arcPath.transition().duration(donutDuration).attrTween("d",arcTween),d3.selectAll(".arc-label").data(pie(donutData)).transition().duration(donutDuration).attr("transform",function(t){return"translate("+arcDefLabel.centroid(t)+")"}).attr("text-anchor",function(t){return(t.endAngle+t.startAngle)/2>Math.PI?"end":"start"}).text(function(t){return t.data.division_clean})})})});